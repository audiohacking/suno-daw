# Build and release AceForge-Suno for macOS, Windows, and Linux
name: Build and release

on:
  push:
    branches: [main, master]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to upload artifacts to (e.g. v0.1.0). Leave empty to skip upload.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Set compiler environment
        run: |
          echo "CC=/usr/bin/clang" >> $GITHUB_ENV
          echo "CXX=/usr/bin/clang++" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -B build -G Xcode \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release -- -quiet

      - name: Locate plugin artefacts
        id: artefacts
        run: |
          set -e
          AU=$(find build -name "AceForge-Suno.component" -type d 2>/dev/null | head -1)
          VST3=$(find build -name "AceForge-Suno.vst3" -type d 2>/dev/null | head -1)
          [ -n "$AU" ] || AU=$(find build -name "*.component" -type d 2>/dev/null | head -1)
          [ -n "$VST3" ] || VST3=$(find build -name "*.vst3" -type d 2>/dev/null | head -1)
          echo "au_path=$AU" >> $GITHUB_OUTPUT
          echo "vst3_path=$VST3" >> $GITHUB_OUTPUT
          echo "Found AU: $AU"
          echo "Found VST3: $VST3"
          if [ -z "$AU" ] || [ -z "$VST3" ]; then
            echo "Plugin artefacts not found. Build tree:"
            find build -type d \( -name "*.component" -o -name "*.vst3" \) 2>/dev/null || true
            exit 1
          fi

      - name: Create zip archives for release
        run: |
          mkdir -p release-artefacts
          cp -R "${{ steps.artefacts.outputs.au_path }}" "release-artefacts/AceForge-Suno.component"
          cp -R "${{ steps.artefacts.outputs.vst3_path }}" "release-artefacts/AceForge-Suno.vst3"
          echo "zip_path=release-artefacts/AceForgeSuno-macOS-AU-VST3.zip" >> $GITHUB_ENV

      - name: Codesign plugin bundles
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          IDENTITY="${MACOS_SIGNING_IDENTITY:--}"
          echo "Signing plugins with identity: $IDENTITY"
          if [ "$IDENTITY" = "-" ]; then
            xcrun codesign --force --sign - --deep "release-artefacts/AceForge-Suno.component"
            xcrun codesign --force --sign - --deep "release-artefacts/AceForge-Suno.vst3"
          else
            xcrun codesign --force --sign "$IDENTITY" --options runtime --timestamp --deep \
              "release-artefacts/AceForge-Suno.component"
            xcrun codesign --force --sign "$IDENTITY" --options runtime --timestamp --deep \
              "release-artefacts/AceForge-Suno.vst3"
          fi
          cd release-artefacts && zip -r "AceForgeSuno-macOS-AU-VST3.zip" "AceForge-Suno.component" "AceForge-Suno.vst3" && cd ..
          echo "Plugin bundles signed; zip created."

      - name: Prepare pkg payload
        run: |
          mkdir -p payload/Library/Audio/Plug-Ins/Components
          mkdir -p payload/Library/Audio/Plug-Ins/VST3
          cp -R "release-artefacts/AceForge-Suno.component" "payload/Library/Audio/Plug-Ins/Components/"
          cp -R "release-artefacts/AceForge-Suno.vst3" "payload/Library/Audio/Plug-Ins/VST3/"

      - name: Build macOS installer (.pkg)
        run: |
          pkgbuild \
            --root payload \
            --identifier com.audiohacking.aceforge-suno \
            --version 0.1.0 \
            --install-location / \
            release-artefacts/AceForgeSuno-macOS-Installer.pkg
          echo "Installer places AU and VST3 in /Library/Audio/Plug-Ins/."

      - name: Codesign installer (.pkg)
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
          MACOS_INSTALLER_SIGNING_IDENTITY: ${{ secrets.MACOS_INSTALLER_SIGNING_IDENTITY }}
        run: |
          IDENTITY="${MACOS_INSTALLER_SIGNING_IDENTITY:-$MACOS_SIGNING_IDENTITY}"
          IDENTITY="${IDENTITY:--}"
          if [ "$IDENTITY" != "-" ] && [ -n "$IDENTITY" ]; then
            echo "Signing installer pkg with identity: $IDENTITY"
            mv release-artefacts/AceForgeSuno-macOS-Installer.pkg release-artefacts/AceForgeSuno-macOS-Installer-unsigned.pkg
            productsign --sign "$IDENTITY" --timestamp \
              release-artefacts/AceForgeSuno-macOS-Installer-unsigned.pkg \
              release-artefacts/AceForgeSuno-macOS-Installer.pkg
            rm release-artefacts/AceForgeSuno-macOS-Installer-unsigned.pkg
            echo "Installer pkg signed."
          else
            echo "No signing identity; installer pkg is unsigned."
          fi

      - name: Upload release assets
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ (github.event_name == 'release' && github.event.release.tag_name) || inputs.release_tag }}
          files: |
            release-artefacts/AceForgeSuno-macOS-AU-VST3.zip
            release-artefacts/AceForgeSuno-macOS-Installer.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artefacts (push / workflow_dispatch or no release)
        if: github.event_name != 'release' || github.event.release == null
        uses: actions/upload-artifact@v4
        with:
          name: AceForgeSuno-macOS-plugins
          path: release-artefacts/

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Locate plugin artefacts
        id: artefacts
        shell: bash
        run: |
          set -e
          VST3=$(find build -name "AceForge-Suno.vst3" -type d 2>/dev/null | head -1)
          [ -n "$VST3" ] || VST3=$(find build -name "*.vst3" -type d 2>/dev/null | head -1)
          echo "vst3_path=$VST3" >> $GITHUB_OUTPUT
          echo "Found VST3: $VST3"
          if [ -z "$VST3" ]; then
            echo "Plugin artefacts not found. Build tree:"
            find build -type d -name "*.vst3" 2>/dev/null || true
            exit 1
          fi

      - name: Create zip archive for release
        shell: bash
        run: |
          mkdir -p release-artefacts
          cp -R "${{ steps.artefacts.outputs.vst3_path }}" "release-artefacts/AceForge-Suno.vst3"
          cd release-artefacts && 7z a -tzip "AceForgeSuno-Windows-VST3.zip" "AceForge-Suno.vst3" && cd ..
          echo "zip_path=release-artefacts/AceForgeSuno-Windows-VST3.zip" >> $GITHUB_ENV

      - name: Upload release assets
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ (github.event_name == 'release' && github.event.release.tag_name) || inputs.release_tag }}
          files: |
            release-artefacts/AceForgeSuno-Windows-VST3.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artefacts (push / workflow_dispatch or no release)
        if: github.event_name != 'release' || github.event.release == null
        uses: actions/upload-artifact@v4
        with:
          name: AceForgeSuno-Windows-plugins
          path: release-artefacts/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libcurl4-openssl-dev \
            libasound2-dev \
            libfreetype6-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxrandr-dev \
            libgl1-mesa-dev

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Locate plugin artefacts
        id: artefacts
        run: |
          set -e
          VST3=$(find build -name "AceForge-Suno.vst3" -type d 2>/dev/null | head -1)
          [ -n "$VST3" ] || VST3=$(find build -name "*.vst3" -type d 2>/dev/null | head -1)
          echo "vst3_path=$VST3" >> $GITHUB_OUTPUT
          echo "Found VST3: $VST3"
          if [ -z "$VST3" ]; then
            echo "Plugin artefacts not found. Build tree:"
            find build -type d -name "*.vst3" 2>/dev/null || true
            exit 1
          fi

      - name: Create tar.gz archive for release
        run: |
          mkdir -p release-artefacts
          cp -R "${{ steps.artefacts.outputs.vst3_path }}" "release-artefacts/AceForge-Suno.vst3"
          cd release-artefacts && tar -czf "AceForgeSuno-Linux-VST3.tar.gz" "AceForge-Suno.vst3" && cd ..
          echo "archive_path=release-artefacts/AceForgeSuno-Linux-VST3.tar.gz" >> $GITHUB_ENV

      - name: Upload release assets
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ (github.event_name == 'release' && github.event.release.tag_name) || inputs.release_tag }}
          files: |
            release-artefacts/AceForgeSuno-Linux-VST3.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artefacts (push / workflow_dispatch or no release)
        if: github.event_name != 'release' || github.event.release == null
        uses: actions/upload-artifact@v4
        with:
          name: AceForgeSuno-Linux-plugins
          path: release-artefacts/
